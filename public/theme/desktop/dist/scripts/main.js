function getUserById(e){var t;return $.each(GAME.users,function(s,n){n.id==e&&(t=n)}),t}function parseGameData(e){e.responseJSON.users&&(GAME.users=e.responseJSON.users,$.each(e.responseJSON.users,function(t,s){if(s.id==e.responseJSON.current_user)GAME.user=s;else{var n=!1;$.each(GAME.enemies,function(e,t){t.id==s.id&&(n=!0,GAME.enemies[e]=s)}),0==n&&GAME.enemies.push(s)}})),e.responseJSON.question&&(GAME.question=e.responseJSON.question),GAME.game_id=e.responseJSON.game_id,GAME.stage=e.responseJSON.game_stage,GAME.status=e.responseJSON.game_status,GAME.map=e.responseJSON.map,e.responseJSON.settings&&(GAME.next_turn=e.responseJSON.settings.next_step||0),GAME.response=e.responseJSON}function startQuizeTimer(){var e=quiz_timer_default;$("#question-1 .right .timer").text(e),quiz_interval=setInterval(function(){$("#question-1 .right .timer").text(e),e--},1e3)}function quizQuesionRender(){clearInterval(quiz_interval),renderPlayers(),getQuizQuestion(callback=function(){$("#question-1 form.a, #question-1 .numpad, #question-1 .right .timer").slideDown(),$("#question-1 .right .q").html(GAME.question.text),openFrame("question-1"),showPoppups(),startQuizeTimer()})}function takingLand(){getGame(function(){console.log(GAME.status),quizQuesionRender()})}function matchmaking(){getGame(function(){"wait"==GAME.status?(renderPlayers(),setTimeout(matchmaking,1e3)):(renderPlayers(),("start"==GAME.status||"ready"==GAME.status)&&(renderMap(!0),hidePoppups(),takingLand()))})}function renderPlayers(){$.each(GAME.users,function(e,t){$("#question-1 .left .unit").eq(e).find(".name").text(t.name).css({color:t.color})}),$.each(GAME.enemies,function(e,t){0==e&&$("#mathcmaking .ava").first().find(".name").text(t.name),1==e&&$("#mathcmaking .ava").last().find(".name").text(t.name)})}function renderMap(e){if(e=e||!1)var t=0;else var t=500;$(".temp-map").html(""),$.each(GAME.map,function(s,n){if(e){var a=$("<div>         capital:"+n.capital+"<br>        id:"+n.id+"<br>        lives:"+n.lives+"<br>        user_id:"+n.user_id+"<br>        zone:"+n.zone+"      </div>").appendTo(".temp-map").css({"background-color":n.settings.color}).data("zone",n.zone).data("info",n);n.user_id>0&&a.addClass("reserved")}else setTimeout(function(){$("<div>           capital:"+n.capital+"<br>          id:"+n.id+"<br>          lives:"+n.lives+"<br>          user_id:"+n.user_id+"<br>          zone:"+n.zone+"        </div>").appendTo(".temp-map").css({"background-color":n.settings.color}).data("zone",n.zone)},t*s)})}function afterAnswer(){$("#question-1 form.a, #question-1 .numpad, #question-1 .right .timer").slideUp()}function scale(){var e=$(window).width();$("#map").transition({scale:e/bg_width})}function openFrame(e){"close"==e?_history.pop():_history.push(e),"mathcmaking"==e&&matchmaking();var t=_history[_history.length-1];$(".popup-wrapper .popup-holder .popup").removeClass("active"),$(".popup-wrapper .popup-holder .popup#"+t).addClass("active")}function hidePoppups(){$(".popup-wrapper").slideUp()}function showPoppups(){$(".popup-wrapper").slideDown()}var GAME=GAME||{};GAME.game_id=0,GAME.user={},GAME.enemies=[],GAME.status=0,GAME.stage=0,GAME.response={},GAME.map={},GAME.question={},GAME.steps=0,GAME.user_step=0,GAME.statuses=["wait","start","ready","over"],GAME.users={},GAME.question;var getGame=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/get-game",data:{game:GAME.game_id},dataType:"json",success:function(t){t.status&&(parseGameData(t),e(),console.log(t))},error:function(e,t,s){}})};getNormalQuestion=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/question/get-normal",data:{game:GAME.game_id,users:GAME.users_question},dataType:"json",success:function(t){t.status&&(parseGameData(t),e())},error:function(e,t,s){}})},getQuizQuestion=function(e,t){t=t||function(){},e=e||GAME.users,2==GAME.stage&&alert("тревога. Лишний запрос!"),$.ajax({type:"POST",url:"/game/question/get-quiz",data:{game:GAME.game_id,users:e},dataType:"json",success:function(e){e.status&&parseGameData(e)},error:function(e,t,s){}})},sendConquestEmptyTerritory=function(e,t){t=t||function(){},$.ajax({type:"POST",url:"/game/conquest/territory",data:{game:GAME.game_id,zone:e},dataType:"json",success:function(e){e.status&&(console.log(e),t())},error:function(e,t,s){}})},getResultQuestion=function(){$.ajax({type:"POST",url:"/game/question/get-result",data:{game:GAME.game_id,question:GAME.question.id,type:GAME.question.type},dataType:"json",success:function(e){e.status&&(1==GAME.stage?"retry"==e.responseJSON.result?setTimeout(getResultQuestion,500):"standoff"==e.responseJSON.result?alert("Ничья"):showQuestionResult(e):2==GAME.stage&&("standoff"===e.responseJSON.result?alert("Ничья"):"retry"===e.responseJSON.result?setTimeout(getResultQuestion,500):"object"==typeof e.responseJSON.result&&console.log("INSPECT!",e)))},error:function(e,t,s){}})},sendQuestionAnswer=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/question/send-answer",data:{game:GAME.game_id,question:GAME.question.id,answer:GAME.question.answer,time:GAME.question.time},dataType:"json",success:function(t){t.status&&(console.log(t),e())},error:function(e,t,s){}})};var firstTime=(new Date).getTime()/1e3,search_timeout=90,quiz_timer_default=10,quiz_interval;$("body").on("click",".temp-map div",function(e){GAME.user.id!=GAME.next_turn||1!=GAME.stage||$(this).hasClass("reserved")?GAME.user.id==GAME.next_turn&&2==GAME.stage&&$(this).data("info").user_id!=GAME.user.id&&renderNormalQuestion($(this).data("info").user_id):sendConquestEmptyTerritory($(this).data("zone"),function(){getGame(function(){renderMap(!0)})})}),renderNormalQuestion=function(e){GAME.users_question=[GAME.user.id,e],getNormalQuestion(function(){console.log(GAME.response),openFrame("question-2"),showPoppups()})};var last_turn=0;whoTurn=function(){getGame(function(){if(1==GAME.stage){if(GAME.next_turn==GAME.user.id)GAME.next_turn!=last_turn&&(last_turn=GAME.next_turn,alert("Ваш ход! Ваш цвет: "+GAME.user.color+". Кол-во доступных ходов: "+GAME.user.available_steps),hidePoppups());else if(GAME.next_turn!=last_turn){last_turn=GAME.next_turn;var e=getUserById(GAME.next_turn);e?(alert("Ходит игрок:"+e.color+"! Ваш цвет: "+GAME.user.color+". Кол-во доступных ходов: "+GAME.user.available_steps),hidePoppups()):(renderMap(!0),takingLand())}setTimeout(whoTurn,1e3)}else 2==GAME.stage&&(console.log("Этап захвата"),GAME.next_turn==GAME.user.id?alert("Ваш ход. Этап захвата."):(GAME.next_turn!=last_turn&&(last_turn=GAME.next_turn),getResultQuestion()));renderMap(!0)})},showQuestionResult=function(e){GAME.question.result=e.responseJSON.result;var t="";$.each(GAME.users,function(e,s){s.place=GAME.question.result[s.id],t=t+"Игрок: "+s.color+" - "+s.place+" место. \n"}),alert(t),whoTurn()},$(document).ready(function(){$("#question-1 form.a").submit(function(){GAME.question.answer=$(this).find("input").val(),$(this).find("input").val(""),GAME.question.time=10-$("#question-1 .right .timer").text(),sendQuestionAnswer(function(){afterAnswer(),getResultQuestion()})})}),console.log("'Allo 'Allo!");var bg_width=$("#map").width();$(window).resize(function(){scale()}),$(window).load(function(){bg_width=$("#map").width(),scale()}),$(".areas .countur svg path").hover(function(){$(this).closest(".area").toggleClass("active")});var _history=[],_history=["menu"];$("body").on("click","a",function(e){var t=$(this).attr("href").split("#");t[1]&&(openFrame(t[1]),e.preventDefault())}),$("body").on("click",".numpad a",function(e){var t=$(this).closest(".numpad").prev("form").find("input");t.focus(),t.val($(this).hasClass("clear")?"":$(this).hasClass("del")?t.val().slice(0,-1):t.val()+$(this).text()),e.preventDefault()}),$("body").on("click",".popup.with-tabs .tabs-btn a",function(e){e.preventDefault();var t=$(".popup.with-tabs .tabs-btn a").index($(this));$(this).is(".active")||($(".popup.with-tabs .tabs-btn a").removeClass("active"),$(this).addClass("active"),$(".popup.with-tabs .tabs .tab").removeClass("active"),$(".popup.with-tabs .tabs .tab").eq(t).addClass("active"))}),$("#help .q").click(function(){$(this).toggleClass("active"),$(this).next(".a").slideToggle()}),_skoronagame_.open_frame&&openFrame(_skoronagame_.open_frame),$("form").submit(function(e){if(e.preventDefault(),$(this).is(".noajax"))return!1;var t=$(this).attr("action"),s=$(this).attr("method"),n=$(this).attr("data-result");$.ajax({type:s,url:t,data:$(this).serialize(),success:function(e){console.log(e),1==e.status?(e.redirect&&(location.href=e.redirect),openFrame(n)):0==e.status&&alert(e)},error:function(e,t,s){console.log(e),console.log(t)}})});