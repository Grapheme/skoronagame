var GAME=GAME||{};GAME.game_id=0,GAME.user={},GAME.status=0,GAME.stage=0,GAME.response={},GAME.map={},GAME.question={},GAME.steps=0,GAME.user_step=0,GAME.statuses=["wait","start","ready","over"],GAME.timer={timer_object:{},time:10},GAME.users,GAME.getGame=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/get-game",data:{game:GAME.game_id},dataType:"json",beforeSend:function(){$("#js-server-response").html("")},success:function(s){s.status&&(GAME.response=s.responseJSON,GAME.map=GAME.response.map,GAME.parseGameResponse(),_skoronagame_.game_id=GAME.game_id,console.log(s),e())},error:function(e,s,t){}})},GAME.overGame=function(){$.ajax({type:"POST",url:"/game/over-game",data:{game:GAME.game_id},dataType:"json",beforeSend:function(){$("#js-server-response").html("")},success:function(e){e.status&&(GAME.response=e.responseJSON,GAME.map=GAME.response.map,GAME.parseGameResponse(),$("#game-id").html(GAME.game_id),$("#js-server-response").html(JSON.stringify(GAME.response))),$("#js-server-notification").html(e.responseText)},error:function(e,s,t){}})},GAME.getQuizQuestion=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/question/get-quiz",data:{game:GAME.game_id,users:GAME.users_question},dataType:"json",beforeSend:function(){$("#js-server-response").html("")},success:function(s){s.status&&(console.log(s),GAME.user_step=0,GAME.response=s.responseJSON,GAME.question.id=GAME.response.question.id,GAME.question.text=GAME.response.question.text,GAME.question.answers=[],GAME.question.type=GAME.response.question.type,e())},error:function(e,s,t){}})},GAME.getNormalQuestion=function(){$.ajax({type:"POST",url:"/game/question/get-normal",data:{game:GAME.game_id,users:GAME.users_question},dataType:"json",beforeSend:function(){$("#js-server-response").html("")},success:function(e){e.status&&(GAME.user_step=0,GAME.response=e.responseJSON,GAME.question.id=GAME.response.question.id,GAME.question.text=GAME.response.question.text,GAME.question.answers=GAME.response.question.answers,GAME.question.type=GAME.response.question.type,GAME.parseQuestionResponse(),$("#js-server-response").html(JSON.stringify(GAME.response))),$("#js-server-notification").html(e.responseText)},error:function(e,s,t){}})},GAME.sendQuestionAnswer=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/question/send-answer",data:{game:GAME.game_id,question:GAME.question.id,answer:GAME.question.answer,time:GAME.question.time},dataType:"json",beforeSend:function(){},success:function(s){s.status&&(console.log(),GAME.response=s.responseJSON,e())},error:function(e,s,t){}})},GAME.getResultQuestion=function(e){e=e||function(){},$.ajax({type:"POST",url:"/game/question/get-result",data:{game:GAME.game_id,question:GAME.question.id,type:GAME.question.type},dataType:"json",beforeSend:function(){$("#js-server-response").html("")},success:function(s){s.status&&(console.log(s),GAME.response=s.responseJSON,e()),$("#js-server-notification").html(s.responseText)},error:function(e,s,t){}})},GAME.sendConquestEmptyTerritory=function(e){$.ajax({type:"POST",url:"/game/conquest/territory",data:{game:GAME.game_id,zone:$(e).data("zone")},dataType:"json",beforeSend:function(){$("#js-server-response").html("")},success:function(s){s.status&&($(e).css("background-color",GAME.user.color).attr("data-user",GAME.user.id).html("Zona: "+$(e).data("zone")+"<br>ID: "+$(e).data("zone_id")+"<br>User: "+$(e).data("user")+"<br>Lives: "+$(e).data("lives")),GAME.response=s.responseJSON,GAME.steps--,0==GAME.steps&&$("#js-question-game").parent().show(),$("#js-server-response").html(JSON.stringify(GAME.response))),$("#js-server-notification").html(s.responseText)},error:function(e,s,t){}})},GAME.sendConquestTerritory=function(e){},GAME.parseGameResponse=function(){GAME.game_id=GAME.response.game_id,GAME.status=GAME.response.game_status,GAME.stage=GAME.response.game_stage,GAME.users=GAME.response.users,GAME.user_step=GAME.response.settings.next_step,$.each(GAME.response.users,function(e,s){s.id==GAME.response.current_user&&(GAME.user=s)}),GAME.status==GAME.statuses[1]?(GAME.createMap(),GAME.user_step==GAME.user.id&&(GAME.stage=1)):GAME.status==GAME.statuses[2]&&(GAME.updateMap(),0==GAME.user_step&&(1==GAME.stage&&$.isEmptyObject(GAME.question)||2==GAME.stage))},GAME.parseQuestionResponse=function(){if(1==GAME.stage)GAME.question.id>0?($("#js-question-game").parent().hide(),$("#quiz-question-text").html(GAME.question.text),$("#quiz-question-block").show(),GAME.startTimer()):GAME.getQuizQuestion();else if(2==GAME.stage)if("normal"==GAME.question.type)if(GAME.question.id>0&&GAME.question.answers.length>0){$("#js-question-game").parent().show();var e="";$.each(GAME.question.answers,function(s,t){e=e+'<input type="radio" name="answer" value="'+s+'">'+t}),$("#normal-question-text").html(GAME.question.text),$("#normal-question-answers").html(e),$("#normal-question-block").show(),GAME.startTimer()}else GAME.getNormalQuestion();else"quiz"==GAME.question.type&&(GAME.question.id>0?($("#js-question-game").parent().hide(),$("#quiz-question-text").html(GAME.question.text),$("#quiz-question-block").show(),GAME.startTimer()):GAME.getQuizQuestion())},GAME.parseResultQuestionResponse=function(){1==GAME.stage?"standoff"===GAME.response.result?(GAME.question={},GAME.getQuizQuestion(),$("#js-question-result").parent().hide(),$("#js-question-game").parent().show()):"retry"===GAME.response.result?(GAME.getResultQuestion(),$("#js-question-result").parent().hide(),$("#js-question-game").parent().hide()):"object"==typeof GAME.response.result&&(GAME.question={},GAME.users_question=[],$("#js-question-result").parent().hide(),$("#js-question-game").parent().hide(),GAME.steps=Math.abs(GAME.response.result[GAME.user.id]-3)):2==GAME.stage&&("standoff"===GAME.response.result?(GAME.question={},GAME.getQuizQuestion()):"retry"===GAME.response.result?GAME.getResultQuestion():"object"==typeof GAME.response.result&&(GAME.question={},GAME.users_question=[],GAME.steps=GAME.response.result[GAME.user.id]))},GAME.createMap=function(){var e=$("#map-block-template"),s="";$.each(GAME.map,function(t,n){s=n.user_id>0?"js-map-block":"js-map-empty-block",n.lives>1&&(s="js-map-capital-block"),$(e).clone(!0).appendTo($("#russia-map-blocks")).removeAttr("id").addClass(s).attr("data-zone",n.zone).attr("data-lives",n.lives).attr("data-user",n.user_id).attr("data-zone_id",n.id).css("background-color",n.settings.color).html("Zona: "+n.zone+"<br>ID: "+n.id+"<br>User: "+n.user_id+"<br>Lives: "+n.lives)}),$("#map-block-template").remove(),$("#russia-map").show()},GAME.updateMap=function(){(GAME.isEmptyMap===!1||0==$(".js-map-block").length)&&GAME.createMap();var e="";$.each(GAME.map,function(s,t){e=t.user_id>0?"js-map-block":"js-map-empty-block",t.lives>1&&(e="js-map-capital-block"),$(".territory-block[data-zone='"+t.zone+"']").addClass(e).attr("data-zone",t.zone).attr("data-lives",t.lives).attr("data-user",t.user_id).attr("data-zone_id",t.id).css("background-color",t.settings.color).html("Zona: "+t.zone+"<br>ID: "+t.id+"<br>User: "+t.user_id+"<br>Lives: "+t.lives)})},GAME.startTimer=function(){var e=GAME.timer.time,s=$("#"+GAME.question.type+"-question-timer span");s.text(e).parent("p"),GAME.question.time=0,GAME.timer.timer_object=setInterval(function(){s.text(--e),GAME.question.time=GAME.question.time+1||1,0>=e&&(clearInterval(GAME.timer.timer_object),"quiz"==GAME.question.type?GAME.question.answer=0:"normal"==GAME.question.type&&(GAME.question.answer=100),GAME.sendQuestionAnswer(),$("#"+GAME.question.type+"-question-block").hide())},1e3)},GAME.isEmptyMap=function(){return 0===GAME.map.length};
function scale(){var t=$(window).width();$("#map").transition({scale:t/bg_width})}function openFrame(t){"close"==t?_history.pop():_history.push(t),"mathcmaking"==t&&startOrSearch();var a=_history[_history.length-1];$(".popup-wrapper .popup-holder .popup").removeClass("active"),$(".popup-wrapper .popup-holder .popup#"+a).addClass("active")}function hidePoppups(){$(".popup-wrapper").slideUp()}function showPoppups(){$(".popup-wrapper").slideDown()}console.log("'Allo 'Allo!");var bg_width=$("#map").width();$(window).resize(function(){scale()}),$(window).load(function(){bg_width=$("#map").width(),scale()}),$(".areas .countur svg path").hover(function(){$(this).closest(".area").toggleClass("active")});var _history=[],_history=["menu"];$("body").on("click","a",function(t){var a=$(this).attr("href").split("#");a[1]&&(openFrame(a[1]),t.preventDefault())}),$("body").on("click",".numpad a",function(t){var a=$(this).closest(".numpad").prev("form").find("input");a.focus(),a.val($(this).hasClass("clear")?"":$(this).hasClass("del")?a.val().slice(0,-1):a.val()+$(this).text()),t.preventDefault()}),$("body").on("click",".popup.with-tabs .tabs-btn a",function(t){t.preventDefault();var a=$(".popup.with-tabs .tabs-btn a").index($(this));$(this).is(".active")||($(".popup.with-tabs .tabs-btn a").removeClass("active"),$(this).addClass("active"),$(".popup.with-tabs .tabs .tab").removeClass("active"),$(".popup.with-tabs .tabs .tab").eq(a).addClass("active"))}),$("#help .q").click(function(){$(this).toggleClass("active"),$(this).next(".a").slideToggle()}),_skoronagame_.open_frame&&openFrame(_skoronagame_.open_frame),$("form").submit(function(t){if(t.preventDefault(),$(this).is(".noajax"))return!1;var a=$(this).attr("action"),e=$(this).attr("method"),s=$(this).attr("data-result");$.ajax({type:e,url:a,data:$(this).serialize(),success:function(t){console.log(t),1==t.status?(t.redirect&&(location.href=t.redirect),openFrame(s)):0==t.status&&alert(t)},error:function(t,a,e){console.log(t),console.log(a)}})});
function renderPlayers(){$.each(GAME.users,function(e,t){if(t.id!=GAME.user.id){var i=!1;$("#mathcmaking .ava .name").each(function(){$(this).text()==t.name&&(i=!0)}),0==i&&$("#mathcmaking .ava:not(.reserved):first .name").text(t.name).closest(".ava").addClass("reserved")}$("#question-1 .left .unit").eq(e).find(".name").text(t.name)})}function renderMap(){$(".temp-map").html(""),$.each(GAME.map,function(e,t){$("<div>       capital:"+t.capital+"<br>      id:"+t.id+"<br>      lives:"+t.lives+"<br>      user_id:"+t.user_id+"<br>      zone:"+t.zone+"    </div>").appendTo(".temp-map").css({"background-color":t.settings.color})})}function quizTimerStart(){$("#question-1 .right .timer").text(quiz_timer),setInterval(function(){var e=$("#question-1 .right .timer").text();$("#question-1 .right .timer").text(e-1)},1e3)}function getQuize(){GAME.users_question=[],GAME.getQuizQuestion(function(){var e=parseInt($("#question-1 .title .qn").text());$("#question-1 .title .qn").text(e+1),$("#question-1 .right .q").html(GAME.question.text),openFrame("question-1"),showPoppups(),quizTimerStart()})}function startOrSearch(){GAME.game_id=_skoronagame_.game_id,GAME.getGame(function(){if(renderPlayers(),"wait"==GAME.status){var e=(new Date).getTime()/1e3;search_timeout>e-firstTime||alert("Игроки не найдены!")}else"start"==GAME.status?setTimeout(getQuize(),1e3):"ready"==GAME.status?(getQuize(),renderMap()):"over"==GAME.status&&(alert("Игра завершена одним из игроков."),location.href="/game");console.log(GAME.status),window.setTimeout(startOrSearch,5e3)})}var firstTime=(new Date).getTime()/1e3,search_timeout=90,quiz_timer=10;$("#question-1 form.a").submit(function(){GAME.question.answer=$(this).find("input").val(),GAME.question.time=10-$("#question-1 .right .timer").text(),GAME.sendQuestionAnswer(),GAME.getResultQuestion()});